#summary Notes and guidelines for people who want to contribute patches or code to the Gerardus project

<wiki:toc max_depth="2" />

= Contributing to the project =

 # Any communications should be carried on the [http://groups.google.com/group/gerardus-users/ mailing list] (gerardus-users@googlegroups.com)
 # There are two ways to contribute code:
  * Sending patches to the mailing list. Then one of the developers will apply the patch, test it, and if there are no problems, commit the changes to the repository
  * If you are in the [http://code.google.com/p/gerardus/people/list committers list], then you can commit your code directly to the repository

== Sending patches ==

If you spot a bug in the code, or want to improve a function, but you are not in the [http://code.google.com/p/gerardus/people/list committers list], this is the simplest way to contribute.

 # Check out a read-only version of Gerardus
  * In Linux
{{{
$ svn co http://gerardus.googlecode.com/svn/trunk/ gerardus
}}}
  * In Windows (e.g. using TortoiseSVN) select the URL "`http://gerardus.googlecode.com/svn/trunk/`" and the destination folder "`gerardus`"
 # Or if you already have checked out the code in the past, make sure that you have the latest version
  * In Linux
{{{
$ svn up
}}}
  * In Windows, select right-click and select "Update" from the TortoiseSVN menu
 # Edit the files you want to improve
 # Create a patch with your changes
  * In Linux
{{{
$ cd gerardus
$ svn diff > file.patch
}}}
  * In Windows, right-click on the "`gerardus`" folder and select "Diff" from the TortoiseSVN menu. Save the result as e.g. `file.patch`
 # Email `file.patch` to the mailing list with an explanation of what you have done

= Notes about reading vectors from Matlab into different types of C++ vector-like objects =

(This section was spawned from this [https://groups.google.com/d/msg/gerardus-users/pLH0iR0H74o/rNC2Qr20_iMJ email sent to the gerardus-user mailing list])

Our `MatlabImportFilter` can read vectors as input parameters directly from Matlab, and pass them to ITK without intermediate steps. For example, in the `itk::VotingBinaryIterativeHoleFillingImageFilter`

[https://code.google.com/p/gerardus/source/browse/trunk/matlab/ItkToolbox/ItkImFilter.cpp?r=1113#506]

{{{
// The variance for the discrete Gaussian kernel. Sets the
// variance independently for each dimension. The default is 0.0
// in each dimension (ITK)
typename FilterType::ArrayType defVariance;
defVariance.Fill(0.0);
filter->SetVariance(matlabImport->
                     GetRowVectorArgument<typename FilterType::ArrayType::ValueType, 
                                             typename FilterType::ArrayType,
                                             VImageDimension>(2, "VAR", defVariance));
}}}

The method `GetRowVectorArgument()` is declared here

[https://code.google.com/p/gerardus/source/browse/trunk/matlab/MatlabImportFilter.h?r=1113#194]

Because we may want to read Matlab vectors into very different classes, e.g. `itk::Size<Dimension>` vs. `CGAL::Direction_3<CGAL::Simple_cartesian<double> >`, the definition of this method relies heaviy on the idea of a vector wrapper,

[https://code.google.com/p/gerardus/source/browse/trunk/matlab/MatlabImportFilter.hxx?r=1113#326]

{{{
VectorWrapper<VectorValueType, VectorType, mxLogical, VectorSize> paramWrap;
}}}

That is, we have a class `VectorWrapper` that provides a common interface from Matlab to different sorts of vectors. For the moment, by default we assume that the output vector is

https://code.google.com/p/gerardus/source/browse/trunk/matlab/VectorWrapper.h?r=1113#75

{{{
std::vector
}}}

but we have partial specialisations to deal with

https://code.google.com/p/gerardus/source/browse/trunk/matlab/VectorWrapper.h?r=1113#121

{{{
itk::Size<Dimension>
itk::FixedArray<ValueType, Dimension>
}}}

https://code.google.com/p/gerardus/source/browse/trunk/matlab/VectorWrapper.h?r=1113#205

{{{
CGAL::Point_3<CGAL::Simple_cartesian<ValueType> >
CGAL::Direction_3<CGAL::Simple_cartesian<ValueType> >
}}}

For ITK this already covers quite a bit of possibilities, because many types get reduced to the two above. For example, the `itk::BoxFilterType<...,...>::RadiusType` used in the Median filter is actually an `itk::FixedArray<double, Dimension>`.

https://code.google.com/p/gerardus/source/browse/trunk/matlab/ItkToolbox/ItkImFilter.cpp?r=1113#752


= Matlab code guidelines =

 * All Matlab (.m) and MEX (.cpp, .hpp) functions live in directory [http://code.google.com/p/gerardus/source/browse/#svn%2Ftrunk%2Fmatlab `gerardus\matlab`], under 6 toolbox directories:
  * [http://code.google.com/p/gerardus/source/browse/#svn%2Ftrunk%2Fmatlab%2FCardiacToolbox CardiacToolbox]: functions that are only relevant for heart modelling and image processing
  * [http://code.google.com/p/gerardus/source/browse/#svn%2Ftrunk%2Fmatlab%2FFileFormatToolbox FileFormatToolbox]: functions to load and save data from and to files, and convert between file formats
  * [http://code.google.com/p/gerardus/source/browse/#svn%2Ftrunk%2Fmatlab%2FFiltersToolbox FiltersToolbox]: functions to run filters or general image processing on 2D/3D images
  * [http://code.google.com/p/gerardus/source/browse/#svn%2Ftrunk%2Fmatlab%2FItkToolbox ItkToolbox]: MEX functions to run ITK filters and transforms from Matlab
  * [http://code.google.com/p/gerardus/source/browse/#svn%2Ftrunk%2Fmatlab%2FPointsToolbox PointsToolbox]: functions to process sets of points, landmarks, configurations...
  * [http://code.google.com/p/gerardus/source/browse/#svn%2Ftrunk%2Fmatlab%2FThirdPartyToolbox ThirdParty]: functions written by people from other projects, but that Gerardus uses
 * All function names are lower-case, e.g. `scinrrd_intersect_plane()`
 * All variable names, input and output arguments are lower-case. An exception to this is when the variable or argument is a boolean flag, when sometimes it's OK to make it all upper-case, e.g. `FOUND = true;`
 * All functions must have a help header. Have a look at the current functions to get an idea of the format, e.g.
{{{
% SCINRRD_INTERSECT_PLANE  Intersection of a plane with an image volume
%
% [IM, GX, GY, GZ, MIDX] = SCINRRD_INTERSECT_PLANE(NRRD, M, V)
%
%   IM is an image that displays the intersection of the plane with the
%   image volume in SCI NRRD format. Voxels that fall outside the image
%   volume are returned as NaN.
%
%   GX, GY, GZ are matrices of the same size as IM, and contain the
%   Cartesian coordinates of the voxels in IM. You can visualize the
%   resulting plane using
%
%     >> surf(gx, gy, gz, im, 'EdgeColor', 'none')
[...]
}}}
 * All non-third party functions must have a copyright notice, that when first created will look something like this
{{{
% Authors: John Doe <johndoe@gmail.com>
% Copyright Â© 2011 University of Oxford
% Version: 0.1.0
% $Rev$
% $Date$
% 
% University of Oxford means the Chancellor, Masters and Scholars of
% the University of Oxford, having an administrative office at
% Wellington Square, Oxford OX1 2JD, UK. 
%
% This file is part of Gerardus.
%
% This program is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation, either version 3 of the License, or
% (at your option) any later version.
%
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details. The offer of this
% program under the terms of the License is subject to the License
% being interpreted in accordance with English Law and subject to any
% action against the University of Oxford being under the jurisdiction
% of the English Courts.
%
% You should have received a copy of the GNU General Public License
% along with this program.  If not, see <http://www.gnu.org/licenses/>.
}}}
 * If it's a new function, you need to add to the file the subversion property "`svn:eol-style=native`" (so that end-of-line characters will be correct in any operating system), and the keywords "`Rev Date`" (so that the help header gets automatically updated with the revision number and date after each commit)
  * In Linux
{{{
$ svn propset svn:keywords "Rev Date" newfile.m
$ svn propset svn:eol-style native newfile.m
}}}
 * The code must have comments. Start comments with lower-case and no period at the end, e.g.
{{{
% keep track of where the rotation point is using a boolean vector for the
% row position, and another one for the column position. The rotation point
% is at the center of the grid
}}}
 * The number of input/output arguments is checked in the Matlab file with
{{{
% check arguments
error(nargchk(3, 4, nargin, 'struct'));
error(nargoutchk(0, 5, nargout, 'struct'));
}}}
 * Values for missing or empty arguments are set using, e.g.
{{{
% defaults
if (nargin < 4 || isempty(interp))
    interp = 'nn';
end
}}}
 * No white spaces before/after brackets, e.g.
{{{
lmax = ceil(sqrt(sum(([nrrd.axis.size] - 1).^2)));
}}}
 * White space after commas and operations, e.g.
{{{
[gc, gr] = meshgrid(-lmax:lmax, -lmax:lmax);
grcs(1, :) = grcs(1, :) + idxm(1);
}}}

= Integrating the Boost C++ libraries in gerardus =

 # Go to the C++ third-party directory
{{{
$ cd cpp/src/third-party
}}}
 # Download the source code of the [https://svn.boost.org/trac/boost/wiki/CMakeModularizationStatus#CMakeSupport CMake-fied Boost project]
{{{
$ git clone http://github.com/ryppl/boost-zero boost
$ cd boost
$ git submodule update --init
}}}
 # Delete git metadata, and documentation and test directories
{{{
$ find . -name ".git*" | xargs rm -rf
$ find . -name doc | xargs rm -rf
$ find . -name test | grep -v './boost/test$' | xargs rm -rf
}}}
 # Add the remaining files to Gerardus' subversion repository
{{{
$ svn add ../boost
}}}
 # Create a test file with the commit message, e.g. `boost/svn-commit.txt`
{{{
2012-09-04  Ramon Casero  <rcasero@gmail.com>

	* Add cpp/src/third-party/boost:

	- CMake-fied Boost C++ libraries downloaded from

	https://github.com/ryppl/boost-zero

	See details in

	http://code.google.com/p/gerardus/wiki/BuildInstructions#Integrating_the_Boost_C++_libraries_in_gerardus
}}}
 # Start committing directories to the repository. We have to do this in smaller commits, because Google Code won't accept a large commit
{{{
$ svn ci --force-log --file svn-commit.txt -N .
$ svn ci --force-log --file svn-commit.txt build.cmake CMakeLists.txt LICENSE_1_0.txt ryppl
$ svn ci --force-log --file svn-commit.txt -N boost
$ for i in {a..z}; do svn ci --force-log --file svn-commit.txt boost/$i*; done
}}}
 # Comment out doc and test subdirectories from each module's CMakeLists.txt
{{{
$ find . -name CMakeLists.txt | xargs sed -i 's/ryppl_add_doc_subdirectory(doc)/#ryppl_add_doc_subdirectory(doc)/'
$ find . -name CMakeLists.txt | xargs sed -i 's/ryppl_add_test_subdirectory(test)/#ryppl_add_test_subdirectory(test)/'
}}}
 # Fix small bug in `cpp/src/third-party/boost/boost/thread/src/pthread/thread.cpp`
{{{
#include <../src/pthread/timeconv.inl>
}}}
 # Fix small bug in `cpp/src/third-party/boost/boost/inspect/inspect.cpp`. Comment out the paragraph
{{{
  if ( deprecated_ck )
      inspectors.push_back( inspector_element( new boost::inspect::deprecated_macro_check ) );
}}}
 # Build and install Boost separately. This creates, amongst other files and directories, an `include/boost` directory with the header files. Delete all the `.svn` directories, and move this `boost` directory to `gerardus/include`, so that the header files are available to the rest of Gerardus
 # Comment out all Boost modules that we don't need for Gerardus
{{{
$ sed -i 's/^add_subdirectory/#add_subdirectory/' CMakeLists.txt
$ sed -i 's/#add_subdirectory(boost\/config)/add_subdirectory(boost\/config)/' CMakeLists.txt
$ sed -i 's/#add_subdirectory(boost\/date_time)/add_subdirectory(boost\/date_time)/' CMakeLists.txt
$ sed -i 's/#add_subdirectory(boost\/filesystem)/add_subdirectory(boost\/filesystem)/' CMakeLists.txt
$ sed -i 's/#add_subdirectory(boost\/system)/add_subdirectory(boost\/system)/' CMakeLists.txt
$ sed -i 's/#add_subdirectory(boost\/thread)/add_subdirectory(boost\/thread)/' CMakeLists.txt
$ sed -i 's/#add_subdirectory(boost\/chrono)/add_subdirectory(boost\/chrono)/' CMakeLists.txt
}}}
 # Comment out all the `ryppl_export()` blocks in the `CMakeLists.txt` to prevent `make install` from filling `gerardus/lib` with all the files we just saw above when we build Gerardus
{{{
$ find . -name CMakeLists.txt | xargs sed -i '/ryppl_export/,/)/s/.*/# &/'
}}}
  * If in some case we need to uncomment the `ryppl_export()` blocks, run
{{{
$ find . -name CMakeLists.txt | xargs sed -i '/# ryppl_export/,/)/s/^# \(.*\)/\1/g'
}}}
 # We have removed all the boost targets, so now we need to create them manually. Add to the `CMakeLists.txt` of every Boost module that Gerardus needs (`system`, `filesystem`, `thread`) something like
{{{
# install compiled libraries
if(WIN32)
  install(TARGETS
    boost_system
    RUNTIME ARCHIVE
    DESTINATION ${GERARDUS_SOURCE_DIR}/lib)
else(WIN32)
  install(TARGETS
    boost_system
    LIBRARY ARCHIVE
    DESTINATION ${GERARDUS_SOURCE_DIR}/lib)
endif(WIN32)
}}}